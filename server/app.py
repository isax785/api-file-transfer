from datetime import datetime
from flask import Flask, request, send_file 
import os
import base64
import json

# LOCALHOST = return f'http://127.0.0.1:5000'

CUR_DIR = os.path.dirname(os.path.abspath(__file__))

app = Flask(__name__)

def formatted_datetime():
    return datetime.now().strftime("%d%m%Y-%H%M%S")

@app.route("/download_dict", methods=['GET'])
def download_dict():
    date = datetime.now().strftime("%d/%m/%Y")
    time = datetime.now().strftime("%H:%M:%S")
    message = f"Message generated by the server in date {date} at {time}."
    return {'message': message}


@app.route("/upload_dict", methods=['POST'])
def upload_dict():
    req = request.get_json()
    text = req['text']
    message = f"Your message '{text}' was rd by the server and returned."
    return {'message': message}


@app.route("/download_file", methods=['GET'])
def download_file():
    "simple download with "
    file_path = os.path.join(CUR_DIR, "res/download_from_server.txt")
    file_name = f"{formatted_datetime()} File from Server"

    return send_file(file_path, as_attachment=True, download_name=file_name) 


@app.route("/upload_file", methods=['POST'])
def upload_file():
    try:
        filename = request.headers.get('filename')
        
        if filename == "":
            return {"message": "No file was uploaded!"}
        
        file = request.files['file'].read() # byte string literal content 
        file_human = file.decode('utf-8') # decoding for human-readability

        return {"message": f"File '{filename}' received!\n\nContent:\n\n{str(file_human)}"}
    
    except Exception as e:
        return {"message": f"Server error:\n{e}"}


@app.route("/download_dict_file", methods=['POST'])
def download_dict_file():
    try:
        text = request.get_json()['text']
        dt = formatted_datetime()

        date = datetime.now().strftime("%d/%m/%Y")
        time = datetime.now().strftime("%H:%M:%S")
        text = f"File created by the server.\nDate: {date}\nTime: {time}\n\n" + "Here below the text sent by the client:\n\n" + text

        file_folder = os.path.join(CUR_DIR, "res")
        file_name = f"{dt}_server_file.txt"
        file_path = os.path.join(file_folder, file_name)

        with open(file_path, 'w') as f:
            f.write(text)

        print(f"File created: {file_name}")

        with open(file_path, 'rb') as f:
            file_content = f.read()

        # Encode the file content as base64
        encoded_content = base64.b64encode(file_content).decode('utf-8')

        print("File ready to be transferred.")

        os.remove(file_path)

        print(f"{file_name} deleted!")

        return_message = "from server!"

        response_data = {'file_buffer': encoded_content,
                         'message': return_message,
                         'filename': file_name
                         }
        
        return response_data

    except Exception as e:
        return {"message": f"{e}"}   
     
@app.route("/upload_dict_file", methods=['POST'])
def upload_dict_file():
    try:
        data = json.loads(request.form['data'])
        text = data['text']
        file = request.files['file'].read()
        filename = request.headers.get('filename')
        file_human = file.decode('utf-8')

        message = f"Client message:\n\n{text}\n\nFile name: {filename}\n\nFile content:\n\n{file_human}"
        return {"message": message} 
    except Exception as e:
        return {"message": f"{e}"} 


if __name__ == "__main__":
    # app.run(debug=True) # autoupdate for debugging purposes
    app.run() # for running debug (VSCode)
